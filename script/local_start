#!/usr/bin/env bash
#
# Script for running local dev environment.
# Assumes dependencies are managed externally.
# docker, erlang and elixir must be already installed

brew install asdf
asdf plugin add erlang https://github.com/asdf-vm/asdf-erlang.git
asdf plugin-add elixir https://github.com/asdf-vm/asdf-elixir.git
asdf install erlang latest
asdf install elixir latest
asdf local erlang latest
asdf local elixir latest

app_dir=${PWD##*/}

# Create phoenix application
if [[ -f "mix.exs" ]]
then
  echo "Application $app_dir exists!"
else
  echo "Creating new phoenix application: $app_dir"
  cd ..
  yes Y \n| mix phx.new $app_dir
  cd $app_dir
  sed -i '' -e '/compilers.*gettext/d' mix.exs
fi

set -euo pipefail

# Spin up database in docker
echo "Starting a Postgres database in a docker container"
docker_command="docker-compose -f docker-compose.yml"
$docker_command up --no-recreate -d postgres
start_time=$(date +%s)
while true
do
    echo "[&(($(date +%s) - $start_time))s] Waiting for postgres to be ready..."
    docker-compose run --rm postgres psql postgresql://postgres:postgres@postgres/template1 -c select 1 > /dev/null 2>&1 \
    && break
done

# Get deps, compile, create database  and run migrations
mix local.hex --if-missing
mix do deps.get, deps.compile, ecto.create, ecto.migrate
MIX_ENV=dev mix do deps.compile, ecto.create, ecto.migrate
#npm install --prefix assets/

echo "Running server"
open http://localhost:4000 & mix phx.server
